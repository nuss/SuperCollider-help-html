<html><head><title>Writing Primitives</title>
<link rel='stylesheet' href='./../scdoc.css' type='text/css' />
<link rel='stylesheet' href='./../frontend.css' type='text/css' />
<link rel='stylesheet' href='./../custom.css' type='text/css' />
<meta http-equiv='Content-Type' content='text/html; charset=UTF-8' />
<script src='./../scdoc.js' type='text/javascript'></script>
<script src='./../docmap.js' type='text/javascript'></script>
<script src='./../prettify.js' type='text/javascript'></script>
<script src='./../lang-sc.js' type='text/javascript'></script>
<script type='text/javascript'>var helpRoot='./..';</script>
</head>
<ul id='menubar'></ul>
<body onload='fixTOC();prettyPrint()'>
<div class='contents'>
<div class='header'>
<div id='label'>SuperCollider GUIDES</div>
<div id='categories'><a href='./../Browse.html#Internals'>Internals</a></div>
<h1>Writing Primitives</h1>
<div id='summary'>Writing Primitives</div>
</div>
<div class='subheader'>
</div>
<div id='toc'>
<ul class='toc'><li class='toc1'><a href='#Example'>Example</a></li>
<ul class='toc'><li class='toc2'><a href='#SuperCollider code'>SuperCollider code</a></li>
<ul class='toc'></ul><li class='toc2'><a href='#Define your primitive'>Define your primitive</a></li>
<ul class='toc'></ul><li class='toc2'><a href='#Write your primitive'>Write your primitive</a></li>
<ul class='toc'></ul></ul><li class='toc1'><a href='#Guidelines'>Guidelines</a></li>
<ul class='toc'><li class='toc2'><a href='#GC safety'>GC safety</a></li>
<ul class='toc'></ul><li class='toc2'><a href='#Type safety'>Type safety</a></li>
<ul class='toc'></ul></ul><li class='toc1'><a href='#FAQ'>FAQ</a></li>
<ul class='toc'></ul></ul></div><h2><a class='anchor' name='Example'>Example</a></h2>
<h3><a class='anchor' name='SuperCollider code'>SuperCollider code</a></h3>
<pre class='code prettyprint lang-sc'>Cocoa {
    prGetPathsDialog { arg returnSlot;
        _Cocoa_GetPathsDialog
        ^this.primitiveFailed
    }
}</pre>
<h3><a class='anchor' name='Define your primitive'>Define your primitive</a></h3>

<p>In your primitive source code define the primitive:<pre>void initCocoaFilePrimitives()
{
    int base, index;

    base = nextPrimitiveIndex();
    index = 0;

    definePrimitive(base, index++, "_Cocoa_GetPathsDialog", prGetPathsDialog, 2, 0);
    // further primitives can be laid in...
    //definePrimitive(base, index++, "_Cocoa_SaveAsPlist", prSaveAsPlist, 3, 0);
}</pre>
<p>Here is the prototype for definePrimitive:<pre>int definePrimitive(int base, int index, char *name, PrimitiveHandler handler, int numArgs, int varArgs);</pre>
<p>The numArgs is the number of arguments that were passed into the SuperCollider method that calls the primitive, plus one to include the receiver which is passed in as the first argument.
<p>(TODO varArgs ...)<h3><a class='anchor' name='Write your primitive'>Write your primitive</a></h3>

<p><code>g-&gt;sp</code> is the top of the stack and is the last argument pushed. <code>g-&gt;sp - inNumArgsPushed + 1</code> is the receiver and where the result goes.
<p>In this example, the numArgsPushed will be 2 (as specified in definePrimitive)<pre>int prGetPathsDialog(struct VMGlobals *g, int numArgsPushed)
{
    if (!g-&gt;canCallOS) return errCantCallOS; //if its deferred, does this matter ?

    PyrSlot *receiver = g-&gt;sp - 1; // an instance of Cocoa
    PyrSlot *array = g-&gt;sp; // an array

    // ...  the body

    return errNone;
}</pre>
<p>This example does not set the receiver, so the primitive returns the original receiver unchanged (still an instance of Cocoa). Or set the object at <code>receiver</code> which again is at <code>(g-&gt;sp - numArgsPushed + 1)</code>.<h2><a class='anchor' name='Guidelines'>Guidelines</a></h2>
<h3><a class='anchor' name='GC safety'>GC safety</a></h3>

<p>If possible, you should avoid creating objects in a primitive. Primitives are much simpler to write and debug if you pass in an object that you create in SC code and fill in its slots in the primitive.
<p>When you do fill in slots in an object with other objects, you must call <code>g-&gt;gc-&gt;GCWrite(object, other_object)</code> in order to notify the garbage collector that you have modified a slot that it may have already scanned.
<p>If you create more than one object in a primitive you must make sure that all the previously created objects are reachable before you allocate another. In other words you must store them on the stack or in another object's slots before creating another. Creating objects can call the garbage collector and if you have not made your objects reachable, they can get collected out from under you.<div class='note'><span class='notelabel'>NOTE:</span> To summarize, before calling any function that might allocate (like <code>newPyr*</code>) you <strong>must</strong> make sure these critera are fulfilled:<ol>
<li>All objects previously created must be reachable, which means they must exist<ul>
<li>on the <code>g-&gt;sp</code> stack<li>or, in a lang-side class/instance variable<li>or, in a slot of another object that fulfils these criteria.</ul>

<p><li>If any object ( <code>child</code> ) was put inside a slot of another object ( <code>parent</code> ), you must have<ul>
<li>called <code>g-&gt;gc-&gt;GCWrite(parent, child)</code> afterwards<li>and, set <code>parent-&gt;size</code> to the correct value</ul>
</ol>
</div>
<p>Here's an example of how it may look:<pre>int prMyPrimitive(struct VMGlobals* g, int numArgsPushed)
{
    PyrSlot* arg = g-&gt;sp;
    float number;
    int err;

    err = slotFloatVal(arg, &amp;number); // get one float argument
    if(err) return err;

    PyrObject *array = newPyrArray(g-&gt;gc, 2, 0, true);
    array-&gt;size = 0;
    SetObject(arg, array); // return value

    // NOTE: array is now reachable on the stack, since arg refers to g-&gt;sp

    PyrObject *str1 = newPyrString(g-&gt;gc, "Hello", 0, true);
    SetObject(array-&gt;slots, str1);
    array-&gt;size++;
    g-&gt;gc-&gt;GCWrite(array, str1);

    // NOTE: str1 is now reachable in array, which is reachable on the stack

    SetFloat(array-&gt;slots+1, number);
    array-&gt;size++;
    // A float is not an allocated object, so no need for anything special here

    return errNone;
}</pre>
<p>If we would have put <code>SetObject(arg, array);</code> at the end of this function, <code>array</code> would <strong>not</strong> have been reachable at the call to <code>newPyrString</code>, thus breaking the rules and introducing bugs that sooner or later would crash SuperCollider (but most probably not in the faulty code but somewhere else, making it very hard to find!)<div class='warning'><span class='warninglabel'>WARNING:</span> Do not store pointers to PyrObjects in C/C++ variables unless you can absolutely guarantee that they cannot be garbage collected. For example the File and SCWindow classes do this by storing the objects in an array in a classvar. The object has to stay in that array until no C object refers to it. <strong>Failing to observe the above two points can result in very hard to find bugs.</strong></div><h3><a class='anchor' name='Type safety'>Type safety</a></h3>

<p>Since SC is dynamically typed, you cannot rely on any of the arguments being of the class you expect. You should check every argument to make sure it is the correct type.
<p>One way to do this is by using <code>isKindOfSlot</code>. If you just want a numeric value, you can use <code>slotIntVal</code>, <code>slotFloatVal</code>, or <code>slotDoubleVal</code> which will return an error if the value is not a numeric type. Similarly there is <code>slotStringVal</code>.
<p>It is safe to assume that the receiver will be of the correct type because this is ensured by the method dispatch mechanism.<h2><a class='anchor' name='FAQ'>FAQ</a></h2>
<dl>
<dt>Now where do i put the thing to return it?<dd>into <code>g-&gt;sp - inNumArgsPushed + 1</code> (In most primitives this is referred to by the variable <code>a</code>).</dl>

<p><div class='doclink'>source: <a href='file:///usr/local/share/SuperCollider/HelpSource/Guides/WritingPrimitives.schelp'>/usr/local/share/SuperCollider/HelpSource/Guides/WritingPrimitives.schelp</a><br>link::Guides/WritingPrimitives::<br>sc version: 3.7alpha1</div></div></body></html>